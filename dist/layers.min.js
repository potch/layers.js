var Layers=function(t){"use strict";const e=t=>typeof t!=="undefined";const i=/^(\d+(\.\d+)?)%$/;const l=t=>parseFloat(t.match(i)[1])/100;const a=new Map;const n=new Map;const r={createCanvas(t,e){let i=document.createElement("canvas");i.width=t;i.height=e;return i},loadImage(t){if(n.has(t)){return n.get(t)}return new Promise(((e,i)=>{let l=new Image;l.crossOrigin="anonymous";l.onload=()=>{n.set(t,l);e(l)};l.onerror=()=>i();l.src=t}))}};let o=r;function h(t){o=t}const s=({x:t=0,y:i=0,width:l,height:a,x2:n,y2:r})=>{if(!e(l)&&e(n)){l=Math.abs(n-t)}if(t>n){[n,t]=[t,n]}if(!e(a)&&e(r)){a=Math.abs(r-i)}if(i>r){[r,i]=[i,r]}return{x:t,y:i,width:l,height:a}};function f(t,e,a,n){let r=t.width/2;let o=t.height/2;let h=e.width/2;let s=e.height/2;if(n){if(n.x){let t=n.x;if(typeof t==="string"){if(i.test(t)){r=t.width*l(t)}else if(t==="left"){r=0}else if(t==="right"){r=t.width}}if(typeof t==="number"){r=t}}if(n.y){let t=n.y;if(typeof t==="string"){if(i.test(t)){o=e.height*l(t)}else if(t==="top"){o=0}else if(t==="bottom"){o=e.height}}if(typeof t==="number"){o=t}}}if(a){if(a.x){let t=a.x;if(typeof t==="string"){if(i.test(t)){h=e.width*l(t)}else if(t==="left"){h=0}else if(t==="right"){h=e.width}}if(typeof t==="number"){s=t}}if(a.y){let t=a.y;if(typeof t==="string"){if(i.test(t)){s=e.height*l(t)}else if(t==="top"){s=0}else if(t==="bottom"){s=e.height}}if(typeof t==="number"){s=t}}}return{x:h-r,y:s-o}}async function c(t,{canvas:e,container:n}={}){if(t instanceof g){t=t.stack}const{width:r,height:h,layers:d}=t;if(!e){e=o.createCanvas(r,h)}if(n){let t;if(n instanceof HTMLElement){t=n}else if(typeof n==="string"){t=document.querySelector(n)}if(t&&e.parentNode!==t){t.append(e)}}if(e.width!==r)e.width=r;if(e.height!==h)e.height=h;let u=s({width:r,height:h});let m=e.getContext("2d");m.clearRect(0,0,r,h);for(let t=d.length-1;t>=0;t--){let e=d[t];if(e.disabled)continue;m.save();m.globalCompositeOperation=e.mode||"source-over";m.globalAlpha=e.opacity||1;if(e.transform){if(e.transform.x||e.transform.y){m.translate(e.transform.x||0,e.transform.y||0)}if(e.transform.rotate){m.translate(r/2,h/2);m.rotate(e.transform.rotate*Math.PI/180);m.translate(-r/2,-h/2)}}if(e.image){let t=e.image.source;if(e.image.url){try{t=await o.loadImage(e.image.url)}catch(t){console.warn("Unable to load image "+e.image.url,t)}}if(t){let a=e.image.anchor;let n=e.image.position;let o=e.image.size;let s=t.width;let c=t.height;if(o.width){s=o.width;if(!o.height){c=t.height/t.width*s}}if(o.height){c=o.height;if(!o.height){s=t.width/t.height*c}}if(o==="cover"){let e=Math.min(t.width/r,t.height/h);s=t.width/e;c=t.height/e}if(o==="contain"){let e=Math.max(t.width/r,t.height/h);s=t.width/e;c=t.height/e}if(typeof o==="string"&&i.test(o)){let e=l(o);let i=Math.max(t.width/r,t.height/h);s=t.width/i*e;c=t.height/i*e}let g=f({width:s,height:c},u,n,a);m.drawImage(t,g.x,g.y,s,c)}}else if(e.filter){let t;if(typeof e.filter==="string"&&a.has(e.filter)){t=a.get(e.filter)}if(typeof e.filter==="function"){t=e.filter}if(t){let i=await t(m.getImageData(0,0,r,h),e.filterOptions);m.putImageData(i,0,0)}else{console.warn(`failed to apply unknown filter "${e.filter}"`)}}else if(e.group){let t=await c({width:r,height:h,layers:e.group});m.drawImage(t,0,0)}else if(e.text){let t=e.text;let i=t.font||{};let l=i.family||"sans-serif";let a=i.size||"12px";let n=i.weight||"normal";m.fillStyle=t.color||"#000";m.strokeStyle=t.stroke||"#000";m.lineWidth=t.strokeWidth||1;m.font=`${n} ${a} ${l}`;m.textAlign=t.align||"center";m.textBaseline=t.verticalAlign||"middle";let r=t.position;let o=f({width:0,height:0},u,r);if("stroke"in t){m.lineJoin="round";m.strokeText(t.text,o.x,o.y)}m.fillText(t.text,o.x,o.y)}else if(e.shape){let t=e.shape;let a=t.anchor;let n=t.position;let o=0;let s=0;if(t.width){let e=t.width;if(typeof e==="string"&&i.test(e)){let t=l(e);o=r*t}else{o=e}if(!("height"in t)){s=e}}if(t.height){let e=t.height;if(typeof e==="string"&&i.test(e)){let t=l(e);s=h*t}else{s=e}if(!("width"in t)){o=e}}let c=f({width:o,height:s},u,n,a);m.fillStyle=t.color;m.strokeStyle=t.stroke;let g=t.type;if(g==="ellipse"){m.beginPath();m.ellipse(c.x+o/2,c.y+s/2,o/2,s/2,0,0,Math.PI*2);m.fill()}else{m.fillRect(c.x,c.y,o,s)}}else if(e.fill){m.fillStyle=e.fill;m.fillRect(0,0,r,h)}m.restore()}return e}class g{constructor(t,{canvas:e,container:i}={}){this.stack=t||{layers:[],width:1,height:1};this.canvas=e;this.container=i}layer(t){if(typeof t==="number"){return this.stack.layers[t]}else if(typeof t==="string"){return this.stack.layers.find((e=>e.name===t))}}render({canvas:t,container:e}={}){return c(this.stack,{canvas:t||this.canvas,container:e||this.container})}}function d(t,e){a.set(t,e)}const u=(t,e,i)=>t+i*(e-t);const m=(t,e,i)=>[u(t[0],e[0],i),u(t[1],e[1],i),u(t[2],e[2],i),u(t[3],e[3],i)];function y(t,e,i){if(e<0||i<0||e>=t.width||i>=t.height){return[0,0,0,0]}let l=(i*t.width+e)*4;return t.data.slice(l,l+4)}function p(t,e,i,l,a,n,r){let o=(i*t.width+e)*4;t.data[o]=l;t.data[o+1]=a;t.data[o+2]=n;t.data[o+3]=r}const w=(t,e)=>{let i=t[3]/255;let l=e[3]/255;return[t[0]*i+e[0]*l*(1-i),t[1]*i+e[1]*l*(1-i),t[2]*i+e[2]*l*(1-i),(i+l*(1-i))*255]};function x(t,e,i){let l=Math.floor(e);let a=Math.ceil(e);let n=Math.floor(i);let r=Math.ceil(i);let o=(e%1+1)%1;let h=(i%1+1)%1;return m(m(y(t,l,n),y(t,a,n),o),m(y(t,l,r),y(t,a,r),o),h)}const M=(t,e,i,l)=>u(u(t,e,l),u(e,i,l),l);const b=(t,e,i,l,a)=>u(M(t,e,i,a),M(e,i,l,a),a);function v(t,e,i,l,a){return[b(0,t,i,1,a),b(0,e,l,1,a)]}function k(t,e,i,l,a){let n=.5;let r=.5;const o=1/512;while(r>o){let o=v(t,e,i,l,n)[0];let h=v(t,e,i,l,Math.min(n+r,1))[0];let s=v(t,e,i,l,Math.max(n-r,0))[0];let f=Math.abs(o-a);let c=Math.abs(h-a);let g=Math.abs(s-a);if(c<g&&c<f){n=Math.min(n+r,1)}else if(g<c&&g<f){n=Math.max(n-r,0)}r=r/2}return n}function I(t,e,i,l,a){return v(t,e,i,l,k(t,e,i,l,a))}var _=Object.freeze({__proto__:null,lerp:u,clerp:m,getPixel:y,setPixel:p,paint:w,samplePixel:x,bezier3:M,bezier4:b,bezier:v,bezierAlgebraic:k,bezierByX:I});function z(t){let e=t.data;for(let t=0;t<e.length;t=t+4){let i=e[t];let l=e[t+1];let a=e[t+2];let n=.299*i+.587*l+.114*a;e[t]=e[t+1]=e[t+2]=n}return t}function P(t,{amount:e}){let i=t.data;for(let t=0;t<i.length;t=t+4){i[t]=(i[t]-128)*e+128;i[t+1]=(i[t+1]-128)*e+128;i[t+2]=(i[t+2]-128)*e+128}return t}function C(t,{x1:e,y1:i,x2:l,y2:a,amount:n}){let r=t.data;if(typeof n==="number"){e=Math.max(Math.min(.5+n/2,1),0);i=Math.min(Math.max(.5-n/2,0),1);l=Math.min(Math.max(.5-n/2,0),1);a=Math.max(Math.min(.5+n/2,1),0)}const o={};const h=t=>{if(!(t in o)){o[t]=I(e,i,l,a,t/255)[1]*255}return o[t]};for(let t=0;t<r.length;t=t+4){r[t]=h(r[t]);r[t+1]=h(r[t+1]);r[t+2]=h(r[t+2])}return t}const F=(t,e)=>[0,0];function O(t,{displace:e=F}){let i=new ImageData(t.data.slice(0),t.width);let{data:l,width:a,height:n}=i;for(let l=0;l<n;l++){for(let n=0;n<a;n++){let[a,r]=e(n,l);let o=x(t,n-a,l-r);p(i,n,l,...o)}}return i}const S=(t,e)=>[t,e];function j(t,{project:e=S}){let i=new ImageData(t.data.slice(0),t.width);let{data:l,width:a,height:n}=i;for(let l=0;l<n;l++){for(let n=0;n<a;n++){let[a,r]=e(n,l);let o=x(t,a,r);p(i,n,l,...o)}}return i}var D=Object.freeze({__proto__:null,GrayscaleFilter:z,ContrastFilter:P,CurvesFilter:C,DisplacementFilter:O,ProjectionFilter:j});d("grayscale",z);d("displacment",O);d("contrast",P);d("curves",C);d("projection",j);const $=D;t.DOMCanvasEngine=r;t.Stack=g;t.filters=$;t.registerFilter=d;t.render=c;t.useCanvasEngine=h;t.utils=_;Object.defineProperty(t,"__esModule",{value:true});return t}({});
