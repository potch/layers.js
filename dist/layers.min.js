var Layers=function(t){"use strict";const e=t=>typeof t!=="undefined";const i=/^(\d+(\.\d+)?)%$/;const n=t=>parseFloat(t.match(i)[1])/100;const a=new Map;const r=new Map;const l={createCanvas(t,e){let i=document.createElement("canvas");i.width=t;i.height=e;return i},loadImage(t){if(r.has(t)){return r.get(t)}return new Promise(((e,i)=>{let n=new Image;n.crossOrigin="anonymous";n.onload=()=>{r.set(t,n);e(n)};n.onerror=()=>{console.warn("error loading image:",t);i()};n.src=t}))}};let o=l;function h(t){o=t}const f=({x:t=0,y:i=0,width:n,height:a,x2:r,y2:l})=>{if(!e(n)&&e(r)){n=Math.abs(r-t)}if(t>r){[r,t]=[t,r]}if(!e(a)&&e(l)){a=Math.abs(l-i)}if(i>l){[l,i]=[i,l]}return{x:t,y:i,width:n,height:a}};function s(t,e,a,r){let l=t.width/2;let o=t.height/2;let h=e.width/2;let f=e.height/2;if(r){if(r.x){let t=r.x;if(typeof t==="string"){if(i.test(t)){l=t.width*n(t)}else if(t==="left"){l=0}else if(t==="right"){l=t.width}}if(typeof t==="number"){l=t}}if(r.y){let t=r.y;if(typeof t==="string"){if(i.test(t)){o=e.height*n(t)}else if(t==="top"){o=0}else if(t==="bottom"){o=e.height}}if(typeof t==="number"){o=t}}}if(a){if(a.x){let t=a.x;if(typeof t==="string"){if(i.test(t)){h=e.width*n(t)}else if(t==="left"){h=0}else if(t==="right"){h=e.width}}if(typeof t==="number"){f=t}}if(a.y){let t=a.y;if(typeof t==="string"){if(i.test(t)){f=e.height*n(t)}else if(t==="top"){f=0}else if(t==="bottom"){f=e.height}}if(typeof t==="number"){f=t}}}return{x:h-l,y:f-o}}function c(t,e){if(typeof e==="object"){if(!("x"in e)){e.x="center"}if(!("y"in e)){e.y="center"}if(typeof e.y==="string"){if(i.test(e.y)){e.y=t.height*n(e.y)}else if(e.y==="top"){e.y=0}else if(e.y==="center"){e.y=t.height/2}else if(e.y==="bottom"){e.y=t.height}}if(typeof e.x==="string"){if(i.test(e.x)){e.x=t.width*n(e.x)}else if(e.x==="top"){e.x=0}else if(e.x==="center"){e.x=t.width/2}else if(e.x==="bottom"){e.x=t.width}}return e}return{x:t.width/2,y:t.height/2}}function g(t,e,i){if(typeof i==="string")return i;if(typeof i==="object"){if(i.gradient){let{start:n,end:a,colors:r}=i.gradient;n=n?c(e,n):{x:e.width/2,y:0};a=a?c(e,a):{x:e.width/2,y:e.height};let l=t.createLinearGradient(n.x,n.y,a.x,a.y);r.forEach(((t,e)=>{let i=e/(r.length-1);let n=t;if(t instanceof Array){i=t[0];n=t[1]}l.addColorStop(i,n)}));return l}}}async function d(t,{canvas:e,container:i}={}){if(t instanceof m){t=t.stack}const{width:n,height:a,layers:r}=t;if(!e){e=o.createCanvas(n,a)}if(i){let t;if(i instanceof HTMLElement){t=i}else if(typeof i==="string"){t=document.querySelector(i)}if(t&&e.parentNode!==t){t.append(e)}}if(e.width!==n)e.width=n;if(e.height!==a)e.height=a;let l=f({width:n,height:a});let h=e.getContext("2d");h.clearRect(0,0,n,a);for(let t=r.length-1;t>=0;t--){let e=r[t];if(e.disabled)continue;h.save();h.globalCompositeOperation=e.mode||"source-over";h.globalAlpha=e.opacity||1;if(e.transform){if(e.transform.x||e.transform.y){h.translate(e.transform.x||0,e.transform.y||0)}if(e.transform.rotate){h.translate(n/2,a/2);h.rotate(e.transform.rotate*Math.PI/180);h.translate(-n/2,-a/2)}}if(e.image){await y(h,l,e.image)}else if(e.filter){await w(h,l,e.filter,e.filterOptions)}else if(e.group){let t=await d({width:n,height:a,layers:e.group});h.drawImage(t,0,0)}else if(e.text){u(h,l,e.text)}else if(e.shape){p(h,l,e.shape)}else if(e.fill){h.fillStyle=g(h,l,e.fill);h.fillRect(l.x,l.y,l.width,l.height)}h.restore()}return e}async function y(t,e,{source:a,url:r,anchor:l,position:h,size:f}){let c=a;if(!c&&r){try{c=await o.loadImage(r)}catch(t){console.warn("Unable to load image "+r,t)}}if(!c)return;let g=c.width;let d=c.height;if(f.width){g=f.width;if(!f.height){d=c.height/c.width*g}}if(f.height){d=f.height;if(!f.height){g=c.width/c.height*d}}if(f==="cover"){let t=Math.min(c.width/e.width,c.height/e.height);g=c.width/t;d=c.height/t}if(f==="contain"){let t=Math.max(c.width/e.width,c.height/e.height);g=c.width/t;d=c.height/t}if(typeof f==="string"&&i.test(f)){let t=n(f);let i=Math.max(c.width/e.width,c.height/e.height);g=c.width/i*t;d=c.height/i*t}let y=s({width:g,height:d},e,h,l);t.drawImage(c,y.x,y.y,g,d)}function u(t,e,{text:i,font:{weight:n="normal",size:a="12px",family:r="sans-serif"},fill:l="#000",stroke:o="#000",strokeWidth:h=1,align:f="center",verticalAlign:c="middle",position:d}){t.fillStyle=g(t,e,l);t.strokeStyle=o;t.lineWidth=h;t.font=`${n} ${a} ${r}`;t.textAlign=f;t.textBaseline=c;let y=s({width:0,height:0},e,d);if(o){t.lineJoin="round";t.strokeText(i,y.x,y.y)}t.fillText(i,y.x,y.y)}async function w(t,e,i,n){if(typeof i==="string"&&a.has(i)){i=a.get(i)}else if(typeof i==="function"){i=i}else{console.warn(`failed to apply invalid filter "${i}"`);return}if(i){let a=await i(t.getImageData(0,0,e.width,e.height),n);t.putImageData(a,0,0)}else{console.warn(`failed to apply unknown filter "${layer.filter}"`)}}function p(t,e,{anchor:a,position:r,type:l,width:o,height:h,fill:f="#000",stroke:c}){if(o){if(typeof o==="string"&&i.test(o)){let t=n(o);o=e.width*t}if(!h){h=o}}if(h){if(typeof h==="string"&&i.test(h)){let t=n(h);h=e.height*t}if(!o){o=h}}let d=s({width:o,height:h},e,r,a);t.fillStyle=g(t,e,f);if(c)t.strokeStyle=c;if(l==="ellipse"){t.beginPath();t.ellipse(d.x+o/2,d.y+h/2,o/2,h/2,0,0,Math.PI*2);t.fill()}else{t.fillRect(d.x,d.y,o,h)}}class m{constructor(t,{canvas:e,container:i}={}){this.stack=t||{layers:[],width:1,height:1};this.canvas=e;this.container=i}layer(t){if(typeof t==="number"){return this.stack.layers[t]}else if(typeof t==="string"){return this.stack.layers.find((e=>e.name===t))}}render({canvas:t,container:e}={}){return d(this.stack,{canvas:t||this.canvas,container:e||this.container})}}function x(t,e){a.set(t,e)}const b=(t,e,i)=>t+i*(e-t);const M=(t,e,i)=>[b(t[0],e[0],i),b(t[1],e[1],i),b(t[2],e[2],i),b(t[3],e[3],i)];function v(t,e,i){if(e<0||i<0||e>=t.width||i>=t.height){return[0,0,0,0]}let n=(i*t.width+e)*4;return t.data.slice(n,n+4)}function k(t,e,i,n,a,r,l=255){let o=(i*t.width+e)*4;t.data[o]=n;t.data[o+1]=a;t.data[o+2]=r;t.data[o+3]=l}const I=(t,e)=>{let i=t[3]/255;let n=e[3]/255;return[t[0]*i+e[0]*n*(1-i),t[1]*i+e[1]*n*(1-i),t[2]*i+e[2]*n*(1-i),(i+n*(1-i))*255]};function _(t,e,i){let n=Math.floor(e);let a=Math.ceil(e);let r=Math.floor(i);let l=Math.ceil(i);let o=(e%1+1)%1;let h=(i%1+1)%1;return M(M(v(t,n,r),v(t,a,r),o),M(v(t,n,l),v(t,a,l),o),h)}const z=(t,e,i,n)=>b(b(t,e,n),b(e,i,n),n);const C=(t,e,i,n,a)=>b(z(t,e,i,a),z(e,i,n,a),a);function P(t,e,i,n,a){return[C(0,t,i,1,a),C(0,e,n,1,a)]}function j(t,e,i,n,a){let r=.5;let l=.5;const o=1/512;while(l>o){let o=P(t,e,i,n,r)[0];let h=P(t,e,i,n,Math.min(r+l,1))[0];let f=P(t,e,i,n,Math.max(r-l,0))[0];let s=Math.abs(o-a);let c=Math.abs(h-a);let g=Math.abs(f-a);if(c<g&&c<s){r=Math.min(r+l,1)}else if(g<c&&g<s){r=Math.max(r-l,0)}l=l/2}return r}function S(t,e,i,n,a){return P(t,e,i,n,j(t,e,i,n,a))}var F=Object.freeze({__proto__:null,lerp:b,clerp:M,getPixel:v,setPixel:k,paint:I,samplePixel:_,bezier3:z,bezier4:C,bezier:P,bezierAlgebraic:j,bezierByX:S});function O(t){let e=t.data;for(let t=0;t<e.length;t=t+4){let i=e[t];let n=e[t+1];let a=e[t+2];let r=.299*i+.587*n+.114*a;e[t]=e[t+1]=e[t+2]=r}return t}function D(t,{amount:e}){let i=t.data;for(let t=0;t<i.length;t=t+4){i[t]=(i[t]-128)*e+128;i[t+1]=(i[t+1]-128)*e+128;i[t+2]=(i[t+2]-128)*e+128}return t}function $(t,{x1:e,y1:i,x2:n,y2:a,amount:r}){let l=t.data;if(typeof r==="number"){e=Math.max(Math.min(.5+r/2,1),0);i=Math.min(Math.max(.5-r/2,0),1);n=Math.min(Math.max(.5-r/2,0),1);a=Math.max(Math.min(.5+r/2,1),0)}const o={};const h=t=>{if(!(t in o)){o[t]=S(e,i,n,a,t/255)[1]*255}return o[t]};for(let t=0;t<l.length;t=t+4){l[t]=h(l[t]);l[t+1]=h(l[t+1]);l[t+2]=h(l[t+2])}return t}const A=(t,e)=>[0,0];function E(t,{displace:e=A}){let i=new ImageData(t.data.slice(0),t.width);let{data:n,width:a,height:r}=i;for(let n=0;n<r;n++){for(let r=0;r<a;r++){let[a,l]=e(r,n);let o=_(t,r-a,n-l);k(i,r,n,...o)}}return i}const L=(t,e)=>[t,e];function R(t,{project:e=L}){let i=new ImageData(t.data.slice(0),t.width);let{data:n,width:a,height:r}=i;for(let n=0;n<r;n++){for(let r=0;r<a;r++){let[a,l]=e(r,n);let o=_(t,a,l);k(i,r,n,...o)}}return i}var T=Object.freeze({__proto__:null,GrayscaleFilter:O,ContrastFilter:D,CurvesFilter:$,DisplacementFilter:E,ProjectionFilter:R});x("grayscale",O);x("displacment",E);x("contrast",D);x("curves",$);x("projection",R);const B=T;t.DOMCanvasEngine=l;t.Stack=m;t.filters=B;t.registerFilter=x;t.render=d;t.useCanvasEngine=h;t.utils=F;Object.defineProperty(t,"__esModule",{value:true});return t}({});
