var Layers=function(t){"use strict";const e=t=>typeof t!=="undefined";const i=/^(\d+(\.\d+)?)%$/;const l=t=>parseFloat(t.match(i)[1])/100;const r=new Map;const a=new Map;const n={createCanvas(t,e){let i=document.createElement("canvas");i.width=t;i.height=e;return i},loadImage(t){if(a.has(t)){return a.get(t)}return new Promise(((e,i)=>{let l=new Image;l.crossOrigin="anonymous";l.onload=()=>{a.set(t,l);e(l)};l.onerror=()=>i();l.src=t}))}};let o=n;const s=({x:t=0,y:i=0,width:l,height:r,x2:a,y2:n})=>{if(!e(l)&&e(a)){l=Math.abs(a-t)}if(t>a){[a,t]=[t,a]}if(!e(r)&&e(n)){r=Math.abs(n-i)}if(i>n){[n,i]=[i,n]}return{x:t,y:i,width:l,height:r}};function h(t,e,r,a){let n=t.width/2;let o=t.height/2;let s=e.width/2;let h=e.height/2;if(a){if(a.x){let t=a.x;if(typeof t==="string"){if(i.test(t)){n=t.width*l(t)}else if(t==="left"){n=0}else if(t==="right"){n=t.width}}if(typeof t==="number"){n=t}}if(a.y){let t=a.y;if(typeof t==="string"){if(i.test(t)){o=e.height*l(t)}else if(t==="top"){o=0}else if(t==="bottom"){o=e.height}}if(typeof t==="number"){o=t}}}if(r){if(r.x){let t=r.x;if(typeof t==="string"){if(i.test(t)){s=e.width*l(t)}else if(t==="left"){s=0}else if(t==="right"){s=e.width}}if(typeof t==="number"){h=t}}if(r.y){let t=r.y;if(typeof t==="string"){if(i.test(t)){h=e.height*l(t)}else if(t==="top"){h=0}else if(t==="bottom"){h=e.height}}if(typeof t==="number"){h=t}}}return{x:s-n,y:h-o}}async function f(t,{canvas:e,container:a}={}){if(t instanceof c){t=t.stack}const{width:n,height:g,layers:d}=t;if(!e){console.log("generating new canvas");e=o.createCanvas(n,g)}if(a){let t;if(a instanceof HTMLElement){t=a}else if(typeof a==="string"){t=document.querySelector(a)}if(t&&e.parentNode!==t){console.log("mounting",e,a);t.append(e)}}if(e.width!==n)e.width=n;if(e.height!==g)e.height=g;let u=s({width:n,height:g});let m=e.getContext("2d");m.clearRect(0,0,n,g);for(let t=d.length-1;t>=0;t--){let e=d[t];if(e.disabled)continue;m.save();m.globalCompositeOperation=e.mode||"source-over";m.globalAlpha=e.opacity||1;if(e.transform){if(e.transform.x||e.transform.y){m.translate(e.transform.x||0,e.transform.y||0)}if(e.transform.rotate){m.translate(n/2,g/2);m.rotate(e.transform.rotate*Math.PI/180);m.translate(-n/2,-g/2)}}if(e.image){let t=e.image.source;if(e.image.url){try{t=await o.loadImage(e.image.url)}catch(t){console.warn("Unable to load image "+e.image.url,t)}}if(t){let r=e.image.anchor;let a=e.image.position;let o=e.image.size;let s=t.width;let f=t.height;if(o.width){s=o.width;if(!o.height){f=t.height/t.width*s}}if(o.height){f=o.height;if(!o.height){s=t.width/t.height*f}}if(o==="cover"){let e=Math.min(t.width/n,t.height/g);s=t.width/e;f=t.height/e}if(o==="contain"){let e=Math.max(t.width/n,t.height/g);s=t.width/e;f=t.height/e}if(typeof o==="string"&&i.test(o)){let e=l(o);let i=Math.max(t.width/n,t.height/g);s=t.width/i*e;f=t.height/i*e}let c=h({width:s,height:f},u,a,r);m.drawImage(t,c.x,c.y,s,f)}}else if(e.filter){let t;if(typeof e.filter==="string"&&r.has(e.filter)){t=r.get(e.filter)}if(typeof e.filter==="function"){t=e.filter}if(t){let i=await t(m.getImageData(0,0,n,g),e.filterOptions);m.putImageData(i,0,0)}else{console.warn(`failed to apply unknown filter "${e.filter}"`)}}else if(e.group){let t=await f({width:n,height:g,layers:e.group});m.drawImage(t,0,0)}else if(e.text){let t=e.font||{};let i=t.family||"sans-serif";let l=t.size||"12px";let r=t.weight||"normal";m.fillStyle=e.color||"#000";m.strokeStyle=e.stroke||"#000";m.lineWidth=e.strokeWidth||1;m.font=`${r} ${l} ${i}`;m.textAlign=t.align||"center";m.textBaseline=t.verticalAlign||"middle";let a=e.position;let o=h({width:0,height:0},{WIDTH:n,HEIGHT:g},a);if("stroke"in e){m.lineJoin="round";m.strokeText(e.text,o.x,o.y)}m.fillText(e.text,o.x,o.y)}else if(e.shape){let t=e.shape;let r=t.anchor;let a=t.position;let o=0;let s=0;if(t.width){let e=t.width;if(typeof e==="string"&&i.test(e)){let t=l(e);o=n*t}else{o=e}if(!("height"in t)){s=e}}if(t.height){let e=t.height;if(typeof e==="string"&&i.test(e)){let t=l(e);s=g*t}else{s=e}if(!("width"in t)){o=e}}let f=h({width:o,height:s},u,a,r);m.fillStyle=e.fill;m.strokeStyle=e.stroke;let c=t.type;if(c==="ellipse"){m.beginPath();m.ellipse(f.x+o/2,f.y+s/2,o/2,s/2,0,0,Math.PI*2);m.fill()}else{m.fillRect(f.x,f.y,o,s)}}else if(e.fill){m.fillStyle=e.fill;m.fillRect(0,0,n,g)}m.restore()}return e}class c{constructor(t,{canvas:e,container:i}={}){this.stack=t||{layers:[],width:1,height:1};this.canvas=e;this.container=i}layer(t){if(typeof t==="number"){return this.stack.layers[t]}else if(typeof t==="string"){return this.stack.layers.find((e=>e.name===t))}}render({canvas:t,container:e}={}){return f(this.stack,{canvas:t||this.canvas,container:e||this.container})}}function g(t,e){r.set(t,e)}const d=(t,e,i)=>t+i*(e-t);const u=(t,e,i)=>[d(t[0],e[0],i),d(t[1],e[1],i),d(t[2],e[2],i),d(t[3],e[3],i)];function m(t,e,i){if(e<0||i<0||e>=t.width||i>=t.height){return[0,0,0,0]}let l=(i*t.width+e)*4;return t.data.slice(l,l+4)}function y(t,e,i,l,r,a,n){let o=(i*t.width+e)*4;t.data[o]=l;t.data[o+1]=r;t.data[o+2]=a;t.data[o+3]=n}const p=(t,e)=>{let i=t[3]/255;let l=e[3]/255;return[t[0]*i+e[0]*l*(1-i),t[1]*i+e[1]*l*(1-i),t[2]*i+e[2]*l*(1-i),(i+l*(1-i))*255]};function w(t,e,i){let l=Math.floor(e);let r=Math.ceil(e);let a=Math.floor(i);let n=Math.ceil(i);let o=(e%1+1)%1;let s=(i%1+1)%1;return u(u(m(t,l,a),m(t,r,a),o),u(m(t,l,n),m(t,r,n),o),s)}const x=(t,e,i,l)=>d(d(t,e,l),d(e,i,l),l);const M=(t,e,i,l,r)=>d(x(t,e,i,r),x(e,i,l,r),r);function b(t,e,i,l,r){return[M(0,t,i,1,r),M(0,e,l,1,r)]}function v(t,e,i,l,r){let a=.5;let n=.5;const o=1/512;while(n>o){let o=b(t,e,i,l,a)[0];let s=b(t,e,i,l,Math.min(a+n,1))[0];let h=b(t,e,i,l,Math.max(a-n,0))[0];let f=Math.abs(o-r);let c=Math.abs(s-r);let g=Math.abs(h-r);if(c<g&&c<f){a=Math.min(a+n,1)}else if(g<c&&g<f){a=Math.max(a-n,0)}n=n/2}return a}function F(t,e,i,l,r){return b(t,e,i,l,v(t,e,i,l,r))}var k=Object.freeze({__proto__:null,lerp:d,clerp:u,getPixel:m,setPixel:y,paint:p,samplePixel:w,bezier3:x,bezier4:M,bezier:b,bezierAlgebraic:v,bezierByX:F});function I(t){let e=t.data;for(let t=0;t<e.length;t=t+4){let i=e[t];let l=e[t+1];let r=e[t+2];let a=.299*i+.587*l+.114*r;e[t]=e[t+1]=e[t+2]=a}return t}function z(t,{amount:e}){let i=t.data;for(let t=0;t<i.length;t=t+4){i[t]=(i[t]-128)*e+128;i[t+1]=(i[t+1]-128)*e+128;i[t+2]=(i[t+2]-128)*e+128}return t}function P(t,{x1:e,y1:i,x2:l,y2:r,amount:a}){let n=t.data;if(typeof a==="number"){e=Math.max(Math.min(.5+a/2,1),0);i=Math.min(Math.max(.5-a/2,0),1);l=Math.min(Math.max(.5-a/2,0),1);r=Math.max(Math.min(.5+a/2,1),0)}const o={};const s=t=>{if(!(t in o)){o[t]=utils.bezierByX(e,i,l,r,t/255)[1]*255}return o[t]};for(let t=0;t<n.length;t=t+4){n[t]=s(n[t]);n[t+1]=s(n[t+1]);n[t+2]=s(n[t+2])}return t}const _=(t,e)=>[0,0];function C(t,{displace:e=_}){let i=new ImageData(t.data.slice(0),t.width);let{data:l,width:r,height:a}=i;for(let l=0;l<a;l++){for(let a=0;a<r;a++){let[r,n]=e(a,l);let o=w(t,a-r,l-n);y(i,a,l,...o)}}return i}const j=(t,e)=>[t,e];function D(t,{project:e=j}){let i=new ImageData(t.data.slice(0),t.width);let{data:l,width:r,height:a}=i;for(let l=0;l<a;l++){for(let a=0;a<r;a++){let[r,n]=e(a,l);let o=w(t,r,n);y(i,a,l,...o)}}return i}var S=Object.freeze({__proto__:null,GrayscaleFilter:I,ContrastFilter:z,CurvesFilter:P,DisplacementFilter:C,ProjectionFilter:D});registerFilter("grayscale",filter.GrayscaleFilter);registerFilter("displacment",filter.DisplacementFilter);registerFilter("contrast",filter.ContrastFilter);registerFilter("curves",filter.CurvesFilter);registerFilter("projection",filter.ProjectionFilter);t.Stack=c;t.filters=S;t.registerFilter=g;t.render=f;t.utils=k;Object.defineProperty(t,"__esModule",{value:true});return t}({});
